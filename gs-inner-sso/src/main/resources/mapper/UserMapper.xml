<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gs.inner.sso.dao.UserMapper">
    <resultMap type="com.gs.inner.sso.entity.User" id="DataResult">
        <result column="id" property="id" />
        <result column="passport" property="passport" />
        <result column="password" property="password" />
        <result column="username" property="username" />
        <result column="email" property="email"/>
        <result column="phone" property="phone"/>
        <result column="createTime" property="createTime" />
        <result column="loginIp" property="loginIp"/>
        <result column="lastLoginIp" property="lastLoginIp"/>
        <result column="loginTime" property="loginTime" />
        <result column="lastLoginTime" property="lastLoginTime" />
        <result column="lastLogoutTime" property="lastLogoutTime"/>
        <result column="locked" property="locked"/>
        <result column="type" property="type"/>
    </resultMap>

    <resultMap type="com.gs.inner.sso.entity.User" id="DataResultWithRole">
        <result column="id" property="id" />
        <result column="passport" property="passport" />
        <result column="password" property="password" />
        <result column="username" property="username" />
        <result column="email" property="email"/>
        <result column="phone" property="phone"/>
        <result column="createTime" property="createTime" />
        <result column="loginIp" property="loginIp"/>
        <result column="lastLoginIp" property="lastLoginIp"/>
        <result column="loginTime" property="loginTime" />
        <result column="lastLoginTime" property="lastLoginTime" />
        <result column="lastLogoutTime" property="lastLogoutTime"/>
        <result column="locked" property="locked"/>
        <result column="type" property="type"/>
        <collection property="roleList" ofType="Role" >
            <id column="id" property="id" />
            <result column="roleName" property="roleName" />
        </collection>
    </resultMap>

    <sql id="insert">
        passport, password, username, email, phone, createTime, loginIp, lastLoginIp, loginTime, lastLoginTime, lastLogoutTime,  locked, type
    </sql>

    <sql id="selectDetail">
        id, passport, username, email, phone,createTime, loginIp, lastLoginIp, loginTime, lastLoginTime, lastLogoutTime, locked, type
    </sql>

    <select id="getUserByPassportAndPassword" resultMap="DataResult">
        <![CDATA[
          SELECT
          ]]>
          <include refid="selectDetail"/>
        <![CDATA[
           FROM InnerUser
           where passport=#{passport} AND password=#{password}
        ]]>
    </select>

    <select id="getUserByPassport" resultMap="DataResult">
        <![CDATA[
          SELECT
          ]]>
        <include refid="selectDetail"/>
        <![CDATA[
           FROM InnerUser where passport=#{passport}
        ]]>
    </select>

    <select id="getUserById" resultMap="DataResult">
        <![CDATA[
          SELECT
          ]]>
        <include refid="selectDetail"/>
        <![CDATA[
           FROM InnerUser where id=#{id}
        ]]>
    </select>

    <!--todo-->
    <select id="getUserWithRoleById" resultMap="DataResultWithRole">
        <![CDATA[
          SELECT
            id, passport, username, email, phone,createTime, loginIp, lastLoginIp, loginTime, lastLoginTime, lastLogoutTime, locked, type,
           FROM InnerUser U left outer join InnerRole A on B.author_id = A.id
           where U.id=#{id}
        ]]>
    </select>

    <select id="getPasswordByPassport" resultType="java.lang.String">
        <![CDATA[
          SELECT password FROM InnerUser where passport=#{passport}
        ]]>
    </select>

    <select id="getCountByPassport" resultType="java.lang.Integer">
        <![CDATA[
          SELECT COUNT(id) FROM InnerUser WHERE passport=#{passport}
        ]]>
    </select>

    <update id="updateUser" parameterType="com.gs.inner.sso.entity.User">
        <![CDATA[
          UPDATE InnerUser SET
          username=#{user.username}, email=#{user.email}, phone=#{user.phone},
           locked=#{user.locked}, type =#{user.type}
          WHERE passport=#{user.passport}
        ]]>
    </update>

    <update id="updateInfo" parameterType="com.gs.inner.sso.entity.User">
        <![CDATA[
        UPDATE InnerUser SET
        loginIp=#{user.loginIp},
          lastLoginIp=#{user.lastLoginIp}, loginTime=#{user.loginTime},
          lastLoginTime=#{user.lastLoginTime}, lastLogoutTime=#{user.lastLogoutTime}
          WHERE passport=#{user.passport}
        ]]>
    </update>

    <!--todo 修改用户角色-->
    <update id="updateUserRole" parameterType="com.gs.inner.sso.entity.User">
        <![CDATA[
          UPDATE InnerUserRoleRelation SET
          roleList=#{user.roleList}
          WHERE passport=#{user.passport}
        ]]>
    </update>

    <update id="updateLogoutTime">
        <![CDATA[
          UPDATE InnerUser SET
          lastLogoutTime=#{logoutTime}
          WHERE passport=#{passport}
        ]]>
    </update>


    <insert id="insertUser" parameterType="com.gs.inner.sso.entity.User">
        <![CDATA[
          INSERT INTO InnerUser (
          ]]>
        <include refid="insert"/>
        <![CDATA[
          )
           VALUES (#{user.passport}, #{user.password},#{user.username}, #{user.email}, #{user.phone}, #{user.createTime}, #{user.loginIp}, #{user.lastLoginIp},#{user.loginTime}, #{user.lastLoginTime}, #{user.lastLogoutTime},  #{user.locked}, #{user.type},#{user.roleList})
        ]]>
    </insert>

</mapper>